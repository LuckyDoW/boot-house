<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link th:href="@{/lib/bootstrap/css/bootstrap.min.css}" rel="stylesheet">
    <link th:href="@{/lib/bootstrap-table/bootstrap-table.min.css}" rel="stylesheet">
    <title>房源列表</title>
</head>
<body>
    <!--查询面板-->
    <div class="panel-group" id="accordion" role="tablist" aria-multiselectable="true">
        <div class="panel panel-primary">
            <div class="panel-heading" role="tab" id="headingOne">
                <h4 class="panel-title">
                    <a data-toggle="collapse" data-parent="#accordion" href="#collapseOne" aria-expanded="true" aria-controls="collapseOne">
                        查询条件
                    </a>
                </h4>
            </div>
            <div id="collapseOne" class="panel-collapse collapse in" role="tabpanel" aria-labelledby="headingOne">
                <div class="panel-body">
                    <form class="form-horizontal" role="form">
                        <!--1、省市区-->
                        <div class="form-group">
                            <!--省-->
                            <label class="col-sm-1 control-label">所在省</label>
                            <div class="col-md-2">
                                <select name="province" id="province" class="form-control">
                                    <option value="">==请选择==</option>
                                </select>
                            </div>
                            <!--市-->
                            <label class="col-sm-1 control-label">所在市</label>
                            <div class="col-md-2">
                                <select name="city" id="city" class="form-control">
                                    <option value="">==请选择==</option>
                                </select>
                            </div>
                            <!--区-->
                            <label class="col-sm-1 control-label">所在区</label>
                            <div class="col-md-2">
                                <select name="area" id="area" class="form-control">
                                    <option value="">==请选择==</option>
                                </select>
                            </div>
                        </div>
                        <!--2、租赁方式<单选>-->
                        <div class="form-group">
                            <label class="col-md-1 control-label">方式</label>
                            <div class="col-md-6" id="rent_mode">
                                <label class="radio-inline">
                                    <input type="radio" name="rentMode" value="" checked> 不限
                                </label>
                            </div>
                        </div>
                        <!--3、租金范围-->
                        <div class="form-group">
                            <label class="col-md-1 control-label">租金</label>
                            <div class="col-md-6" >
                                <label class="checkbox-inline">
                                    <input type="checkbox" name="rental" value="100-1000">1000元以下
                                </label>
                                <label class="checkbox-inline">
                                    <input type="checkbox" name="rental" value="1000-1500">1000-1500元
                                </label>
                                <label class="checkbox-inline">
                                    <input type="checkbox" name="rental" value="1500-2500">1500-2500元
                                </label>
                                <label class="checkbox-inline">
                                    <input type="checkbox" name="rental" value="2500-5000">2500-5000元
                                </label>
                                <label class="checkbox-inline">
                                    <input type="checkbox" name="rental" value="5000-100000">5000元以上
                                </label>

                            </div>
                        </div>
                        <!--4、户型-->
                        <div class="form-group">
                            <label class="col-md-1 control-label">户型</label>
                            <div class="col-md-6" id="house_type">

                            </div>
                        </div>
                        <!--5、朝向-->
                        <div class="form-group">
                            <label class="col-md-1 control-label">朝向</label>
                            <div class="col-md-6" id="orientation">

                            </div>
                        </div>

                        <!--添加按钮-->
                        <div class="form-group">
                            <div class="col-sm-offset-2 col-sm-10">
                                <button id="queryBtn" type="button" class="btn btn-primary">查询</button>
                                <button type="reset" class="btn btn-warning">重置</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!--展示房源列表-->
    <table id="listTable">

    </table>

    <script th:src="@{/lib/js/jquery/jquery.min.js}" type="text/javascript"></script>
    <script th:src="@{/lib/bootstrap/js/bootstrap.min.js}" type="text/javascript"></script>
    <script th:src="@{/lib/bootstrap-table/bootstrap-table.min.js}" type="text/javascript"></script>
    <script th:src="@{/lib/bootstrap-table/bootstrap-table-zh-CN.min.js}" type="text/javascript"></script>
    <script th:inline="javascript" type="text/javascript">
        const path = [[${#request.getContextPath()}]];
        const areaOption = "<option value=''>==请选择==</option>"
        $(function () {
            house.queryList();
            /*查询按钮*/
            $("#queryBtn").click(function () {
                $("#listTable").bootstrapTable("refresh");
            });

            /*省市区查询区域*/
            house.queryArea("province",0);
            $("#province").change(function () {
                //切换省的时候，将市和区县下拉类表框重置
                $("#city").html(areaOption);
                $("#area").html(areaOption);
                if(this.value){
                    house.queryArea('city',this.value);
                }
            })
            $("#city").change(function () {
                $("#area").html(areaOption);
                if(this.value){
                    house.queryArea('area',this.value);
                }
            })
            /*租赁方式（单选框）*/
            house.queryRentMode();
            /*查询面板的户型、朝向(多选框)*/
            house.getQueryPanelDict("orientation");
            house.getQueryPanelDict("house_type")
        })
        let house = {
            /*查询房源列表*/
            queryList:function () {
                $('#listTable').bootstrapTable({
                    url:path+'/house/list',
                    pagination:true,
                    sidePagination: 'server', //服务端分页
                    pageNumber:1,
                    pageSize:10,
                    pageList: [5,10,20,30,40],//分页的每页显示几条
                    queryParamsType: 'undefined',
                    paginationPreText: "上一页",
                    paginationNextText: '下一页',
                    queryParams:function (params) {//传到后端的参数
                        /*定义租金范围*/
                        let rentalList=[];
                        $('input[name="rental"]:checked').each(function () {
                            rentalList.push(this.value);
                        });

                        /*定义租赁方式（单选）*/
                        let rentMode = $("input[name='rentMode']:checked").val();//获取租赁方式的值

                        /*定义户型参数(多选)
                        * unshift将元素添加数组前面
                        * push将元素添加后面
                        * */
                        let houseTypeList = [];
                        $("input[name='house_type']:checked").each(function () {
                            houseTypeList.push(this.value);//追加到houseTypeList后面
                        });

                        /*定义朝向参数（多选）*/
                        let orientationList = [];
                        $("input[name='orientation']:checked").each(function () {
                            orientationList.push(this.value);//追加到orientationList后面
                        });
                        console.log(rentMode);
                        let newParam = {
                            pageNum:params.pageNumber,
                            pageSize:params.pageSize,
                            /*省市区查询条件*/
                            province:$("#province").val(),
                            city:$("#city").val(),
                            area:$("#area").val(),
                            rentMode:rentMode,
                            /* 怎么接收houseTypeList[]: 2 */
                            houseTypeList:houseTypeList.join(','),
                            orientationList:orientationList.join(','),
                            rentalList:rentalList,

                        };
                        return newParam;
                    },
                    columns:[
                        {field:'id',title:'编号'},
                        {field:'areaName',title:'所在区'},
                        {field:'rentModeName',title:'方式'},
                        {field:'rental',title:'租金'},
                        {field:'houseTypeName',title:'户型'},
                        {field:'orientationName',title:'朝向'},
                        {field:'address',title:'地址'},
                        {field:'publishTime',title:'发布时间'},
                        {title:'图片',formatter:function (value,row,index) {
                                return "<img width='50px' height='50px' src='"+path+row.pic+"'/>";
                            }
                        },
                        {title:'操作',formatter(value,row,index){
                                return "更新";
                            }
                        },

                    ]

                });
            },
            queryArea:function (domId,pid) {
                $.ajax({
                    url:path + '/area/queryByPid',
                    type:'GET',
                    data:'pid='+pid,
                    dataType:'json',
                    success:function (res) {
                        let options = "<option value=''>===请选择===</option>"
                        $.each(res,function (index,area) {
                            options += "<option value="+area.id+">"+area.name+"</option>"
                        });
                        $("#" + domId).html(options);
                    }

                });
            },
            /*查询租赁方式*/
            queryRentMode:function () {
                $.ajax({
                    url:path + '/dict/rent_mode',
                    type:'GET',
                    data:"",
                    dataType:'json',
                    success:function (res) {
                        let radios = '';
                        for(let i in res){
                            let showName = res[i].name;
                            let radioValue = res[i].value;
                            radios +="<label class='radio-inline'>"
                                +"<input type='radio' name='rentMode' value='"+radioValue+"'>"+showName
                                +"</label>"
                        }
                        $("#rent_mode").append(radios);
                    }
                });


            },
            /*获取查询面板的字典项 ，户型和朝向*/
            getQueryPanelDict:function (groupId) {
                $.ajax({
                    url:path+'/dict/'+groupId,
                    type:"GET",
                    data:'',
                    dataType:"json",
                    success:function (res) {
                        let checkBox = '';
                        /*name属性为groupId*/
                        $.each(res,function (index,dict) {
                            checkBox +="<label class='checkbox-inline'>" +
                                "<input type='checkbox' name="+groupId+" value="+dict.value+">"+dict.name+"" +
                                "</label>";
                        });
                        $("#"+groupId).html(checkBox);
                    }
                });
            },


        }


    </script>
</body>
</html>